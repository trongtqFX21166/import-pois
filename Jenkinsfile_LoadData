pipeline {
    agent {
        label 'WindowsAgent02'
    }
    
    environment {
        MONGO_CREDENTIALS_USR = 'root'
        MONGO_CREDENTIALS_PSW = 'pAssw0rd'
        TEAMS_WEBHOOK = 'https://vietmapcorp.webhook.office.com/webhookb2/205670f3-463f-4ac3-85f8-f84b9f0da76e@fc2e159c-528b-4132-b3c0-f43226646ad7/JenkinsCI/74682a3b843b46529b662e5d4b85f65e/e1fe988a-0959-44ad-889d-44f6a1637286'
        CURRENT_DATE = new Date().format('yyyyMMdd')
        MONGO_PATH = 'D:\\MongoDb\\bin'
        FTP_PATH = 'D:\\FTP\\POIRaw'
        WORKSPACE = "${WORKSPACE}\\pois"
        BUILD_OUTPUT = "${WORKSPACE}\\POIImport\\Platform.IOTHub.ImportPOI.Service\\bin\\Release\\net8.0"
    }

    parameters {
        string(name: 'mongoDb', description: 'MongoDB Database Name')
        string(name: 'release_BRANCH', defaultValue: '', description: 'Put release branch to run CI/CD')
    }
    
    stages {   
        stage("Clean up") {
            steps {
                cleanWs()
            }
        }

        stage("Clone repo") {
            steps {
                bat '''
                    "C:\\Program Files\\Git\\bin\\bash.exe" -c "git clone ssh://git@bitbucket-ssh.vietmap.vn:7999/HUB/pois.git"
                '''
            }
        }

        stage("Checkout release branch") {
            steps {
                dir("pois") {
                    bat """
                        "C:\\Program Files\\Git\\bin\\bash.exe" -c "git checkout %release_BRANCH%"
                    """
                }              
            }
        }
    

        stage("Build Solution") {
            steps {
                dir("pois") {
                    bat '''
                        dotnet restore POIImport\\Platform.IOTHub.ImportPOI.Service\\Platform.IOTHub.ImportPOI.Service.csproj
                        dotnet build POIImport\\Platform.IOTHub.ImportPOI.Service\\Platform.IOTHub.ImportPOI.Service.csproj -c Release
                    '''
                }
            }
        }

        stage("Verify Build Output") {
            steps {
                script {
                    def exePath = "${BUILD_OUTPUT}\\Platform.IOTHub.ImportPOI.Service.exe"
                    if (!fileExists(exePath)) {
                        error "Build output not found at ${exePath}"
                    }
                }
            }
        }
        
        stage('Import Master Data') {
            steps {
                script {
                    bat """
                        cd "${BUILD_OUTPUT}"
                        Platform.IOTHub.ImportPOI.Service.exe -mode import-master -db "${params.mongoDb}"
                    """
                }
            }
        }

        stage('Import Admin Data') {
            steps {
                script {
                    bat """
                        cd "${BUILD_OUTPUT}"
                        Platform.IOTHub.ImportPOI.Service.exe -mode import-admin -db "${params.mongoDb}" -config appsettings.json
                    """
                }
            }
        }

        stage('Import VM POIs') {
            steps {
                script {
                    bat """
                        cd "${BUILD_OUTPUT}"
                        Platform.IOTHub.ImportPOI.Service.exe -mode import-vm -db "${params.mongoDb}"
                    """
                }
            }
        }

        stage('Import VM Entry POIs') {
            steps {
                script {
                    bat """
                        cd "${BUILD_OUTPUT}"
                        Platform.IOTHub.ImportPOI.Service.exe -mode import-entry -db "${params.mongoDb}"
                    """
                }
            }
        }

        stage('Import Waze Data') {
            steps {
                script {
                    bat """
                        cd "${BUILD_OUTPUT}"
                        Platform.IOTHub.ImportPOI.Service.exe -mode import-waze -db "${params.mongoDb}" -config appsettings.json
                    """
                }
            }
        }

        stage('Add VF Powers') {
            steps {
                script {
                    bat """
                        cd "${BUILD_OUTPUT}"
                        Platform.IOTHub.ImportPOI.Service.exe -mode add-vfpower -db "${params.mongoDb}" -config appsettings.json
                    """
                }
            }
        }

        stage('Add Google Data') {
            steps {
                script {
                    bat """
                        cd "${BUILD_OUTPUT}"
                        Platform.IOTHub.ImportPOI.Service.exe -mode add-gg-data -db "${params.mongoDb}" -config appsettings.json
                    """
                }
            }
        }
    }
    
    post {
        success {
            office365ConnectorSend(
                webhookUrl: "${TEAMS_WEBHOOK}",
                message: """
                    **✅ ETL Map POI Import Process Successful**
                    - Build: ${BUILD_NUMBER}
                    - Database: ${params.mongoDb}
                    - Date: ${CURRENT_DATE}
                    - Duration: ${currentBuild.durationString}
                    - Status: All imports completed successfully
                    
                    [View Build Details](${BUILD_URL})
                """,
                color: '00ff00'
            )
        }
        
        failure {
            office365ConnectorSend(
                webhookUrl: "${TEAMS_WEBHOOK}",
                message: """
                    **❌ ETL Map POI Import Process Failed**
                    - Build: ${BUILD_NUMBER}
                    - Database: ${params.mongoDb}
                    - Date: ${CURRENT_DATE}
                    - Duration: ${currentBuild.durationString}
                    - Failed Stage: ${currentBuild.displayName}
                    
                    [View Logs](${BUILD_URL}console)
                """,
                color: 'ff0000'
            )
        }
    }
}